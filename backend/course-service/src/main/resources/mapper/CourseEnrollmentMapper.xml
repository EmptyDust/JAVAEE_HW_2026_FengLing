<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.student.course.mapper.CourseEnrollmentMapper">

    <!-- 查询学生的选课列表(包含课程详细信息) -->
    <select id="selectMyEnrollmentsWithCourse" resultType="com.student.course.vo.MyEnrollmentVO">
        SELECT
            ce.id AS enrollmentId,
            ce.enrollment_time AS enrollmentTime,
            ce.score,
            ce.grade,
            ci.id AS courseId,
            ci.course_code AS courseCode,
            ci.course_name AS courseName,
            ci.course_type AS courseType,
            ci.credit,
            ci.hours,
            ci.teacher_name AS teacherName,
            ci.semester,
            ci.schedule_info AS scheduleInfo,
            ci.course_description AS courseDescription,
            ci.course_outline AS courseOutline
        FROM course_enrollment ce
        LEFT JOIN course_info ci ON ce.course_id = ci.id
        WHERE ce.student_id = #{studentId}
          AND ce.status = 1
          <if test="courseName != null and courseName != ''">
              AND (ci.course_name LIKE CONCAT('%', #{courseName}, '%')
                   OR ci.course_code LIKE CONCAT('%', #{courseName}, '%'))
          </if>
          <if test="semester != null and semester != ''">
              AND ci.semester = #{semester}
          </if>
        ORDER BY ce.enrollment_time DESC
    </select>

    <!-- 批量查询学生在指定课程中的选课记录 -->
    <select id="selectByStudentAndCourses" resultType="com.student.course.entity.CourseEnrollment">
        SELECT *
        FROM course_enrollment
        WHERE student_id = #{studentId}
          AND status = 1
          AND course_id IN
          <foreach collection="courseIds" item="courseId" open="(" separator="," close=")">
              #{courseId}
          </foreach>
    </select>

    <!-- 检查学生是否已选某课程 -->
    <select id="countByStudentAndCourse" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM course_enrollment
        WHERE student_id = #{studentId}
          AND course_id = #{courseId}
          AND status = 1
    </select>

 <select id="selectCourseStudentsWithDetails" resultType="com.student.course.entity.CourseEnrollment">
      SELECT
          ce.id,
          ce.course_id,
          ce.student_number,
          COALESCE(ce.student_name, s.name) AS student_name,
          ce.class_id,
          COALESCE(ce.class_name, c.class_name) AS class_name,
          ce.enrollment_time,
          ce.status,
          ce.score,
          ce.grade,
          ce.attendance_rate,
          ce.remark,
          ce.create_time,
          ce.update_time
      FROM course_enrollment ce
      LEFT JOIN student s ON ce.student_id = s.id
      LEFT JOIN class c ON ce.class_id = c.id
      WHERE ce.course_id = #{courseId}AND ce.status = 1ORDER BY ce.student_number ASC
  </select>
</mapper>
